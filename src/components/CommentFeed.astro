---
import type { HydratedPost } from "../lib/server/fetch-all-posts";
import CommentPreview from "./CommentPreview.astro";

export interface Props {
    postId: number;
    currentUser: HydratedPost["user"];
    comments: HydratedPost["comments"];
}

let { postId, currentUser, comments } = Astro.props;
comments = comments.sort((lhs, rhs) => lhs.createdOn.getTime() - rhs.createdOn.getTime());
---

<script>
    import { CommentFeedModel } from "~/lib/client/models/comment-feed-model";
    import { Computed } from "~/lib/client/signals";
    import { ReactiveElement } from "~/lib/client/elements/reactive-element";
    import { CommentListItemElement } from "~/lib/client/elements/comment-list-item";
    import { ErrorAlert } from "~/lib/client/elements/error-alert";

    class CommentFeedElement extends ReactiveElement {
        #model = new CommentFeedModel(this.dataset, { signal: this.disconnect.signal });

        #elements = {
            form: this.querySelector("form")!,
            commentIdInput: this.querySelector<HTMLInputElement>("input#commentId")!,
            textArea: this.querySelector("textarea")!,
            button: this.querySelector<HTMLButtonElement>(".button-container > button")!,
            commentsList: this.querySelector("ul")!,
        };

        #commentListElements = new Computed(() =>
            this.#model.comments.map(comment => new CommentListItemElement(comment)),
        );

        #hydrateRendering() {
            // Update the general form elements when the model values change
            this.renderEffect(() => {
                this.#elements.commentIdInput.value = this.#model.tempCommentIdStore.id;
                this.#elements.textArea.value = this.#model.content;
                this.#elements.button.disabled = this.#model.comment.pending;
                this.#elements.textArea.disabled = this.#model.comment.pending;
            });

            // Update the comments list when the comments update
            this.renderEffect(() => {
                if (this.#commentListElements.get().length) {
                    let commentIds = Array.from(this.#elements.commentsList.children).map(
                        element => element.getAttribute("id")!,
                    );

                    this.#elements.commentsList.append(
                        ...this.#commentListElements
                            .get()
                            .filter(element => !commentIds.includes(element.getAttribute("id")!)),
                    );
                }
            });

            // Show error alert if there is an error
            // Hide error alert if error is cleared
            let errorAlert = new ErrorAlert();
            this.renderEffect(() => {
                if (this.#model.comment.error) {
                    errorAlert.message = this.#model.comment.error.message;
                    this.appendChild(errorAlert.content);
                } else {
                    errorAlert.message = null;
                    this.querySelector(".alert")?.remove();
                }
            });
        }

        #hydrateListeners() {
            this.hydrateListener(this.#elements.form, "submit", this.#model.handleFormSubmission);
            this.hydrateListener(this.#elements.textArea, "input", this.#model.handleCommentInput);
        }

        connectedCallback() {
            this.#hydrateRendering();
            this.#hydrateListeners();
        }
    }

    customElements.define("ui-comment-feed", CommentFeedElement);
</script>

<ui-comment-feed data-user-name={currentUser.name} data-user-image={currentUser.image}>
    <ul role="list" class="comments">
        {comments.map(comment => <CommentPreview comment={comment} />)}
    </ul>

    <!-- New comment form -->
    <div class="comment-form-container">
        <img src={currentUser.image} />
        <form>
            <input type="hidden" id="postId" name="postId" value={postId} />
            <input type="hidden" id="commentId" name="commentId" />

            <div class="text-area-container">
                <label for="comment" class="sr-only">Add your comment</label>
                <textarea rows="2" name="comment" id="comment" placeholder="Add your comment..."
                ></textarea>
            </div>

            <div class="button-container">
                <button type="submit">Comment</button>
            </div>
        </form>
    </div>
</ui-comment-feed>
